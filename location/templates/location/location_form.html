<div class="image-preview mt-2" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                      </div>
                    </div>
                    {% if form.profile_image.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.profile_image.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Upload a photo that represents this location (max 5MB)
                    </div>
                  </div>

                  <!-- Copy Client Address -->
                  {% if not form.instance.pk %}
                  <div class="mb-3">
                    <div class="form-check">
                      {{ form.copy_address_from_client|add_class:"form-check-input" }}
                      <label class="form-check-label" for="{{ form.copy_address_from_client.id_for_label }}">
                        Copy address from client
                      </label>
                    </div>
                    <div class="form-text">
                      Automatically populate location address from client's primary address
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- Description -->
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label required">
                      Description
                    </label>
                    {{ form.description|add_class:"form-control" }}
                    {% if form.description.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.description.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Provide a detailed description of the location, including key features and characteristics
                    </div>
                  </div>

                  <!-- Scope Summary -->
                  <div class="mb-3">
                    <label for="{{ form.scope_summary.id_for_label }}" class="form-label">
                      Scope Summary
                    </label>
                    {{ form.scope_summary|add_class:"form-control" }}
                    {% if form.scope_summary.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.scope_summary.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      High-level overview of work scope and objectives for this location
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Location & Coordinates -->
        <div class="form-step" id="step-2">
          <div class="card shadow">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-map-marker-alt me-2"></i>
                Location & Coordinates
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-lg-6">
                  <!-- Location Category -->
                  <div class="mb-3">
                    <label for="{{ form.location_category.id_for_label }}" class="form-label">
                      Location Category
                    </label>
                    {{ form.location_category|add_class:"form-control" }}
                    <datalist id="location_categories">
                      <option value="Urban">
                      <option value="Rural">
                      <option value="Suburban">
                      <option value="Indoor">
                      <option value="Outdoor">
                      <option value="Commercial">
                      <option value="Residential">
                      <option value="Industrial">
                      <option value="Mixed-use">
                    </datalist>
                    {% if form.location_category.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.location_category.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- GPS Coordinates -->
                  <div class="mb-3">
                    <label class="form-label">GPS Coordinates</label>
                    <div class="row">
                      <div class="col-6">
                        <label for="{{ form.latitude.id_for_label }}" class="form-label small">Latitude</label>
                        {{ form.latitude|add_class:"form-control" }}
                        {% if form.latitude.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.latitude.errors|first }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="col-6">
                        <label for="{{ form.longitude.id_for_label }}" class="form-label small">Longitude</label>
                        {{ form.longitude|add_class:"form-control" }}
                        {% if form.longitude.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.longitude.errors|first }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-text">
                      <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="getLocationBtn">
                        <i class="fas fa-crosshairs me-1"></i>Get Current Location
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary mt-2 ms-2" data-bs-toggle="modal" data-bs-target="#coordinatePickerModal">
                        <i class="fas fa-map me-1"></i>Pick on Map
                      </button>
                    </div>
                  </div>

                  <!-- Coordinate Validation -->
                  <div class="mb-3">
                    <div class="form-check">
                      {{ form.validate_coordinates|add_class:"form-check-input" }}
                      <label class="form-check-label" for="{{ form.validate_coordinates.id_for_label }}">
                        Validate GPS coordinates
                      </label>
                    </div>
                    <div class="form-text">
                      Check if coordinates are valid and within expected ranges
                    </div>
                  </div>
                </div>

                <div class="col-lg-6">
                  <!-- Google Maps URL -->
                  <div class="mb-3">
                    <label for="{{ form.google_maps_url.id_for_label }}" class="form-label">
                      Google Maps URL
                    </label>
                    {{ form.google_maps_url|add_class:"form-control" }}
                    {% if form.google_maps_url.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.google_maps_url.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Paste Google Maps share link for directions
                    </div>
                  </div>

                  <!-- Google Plus Code -->
                  <div class="mb-3">
                    <label for="{{ form.google_plus_code.id_for_label }}" class="form-label">
                      Google Plus Code
                    </label>
                    {{ form.google_plus_code|add_class:"form-control" }}
                    {% if form.google_plus_code.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.google_plus_code.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Alternative location identifier (e.g., 9G8F+5W New York)
                    </div>
                  </div>

                  <!-- Coordinate Preview Map -->
                  <div class="mb-3">
                    <label class="form-label">Location Preview</label>
                    <div id="coordinatePreview" class="border rounded p-3 text-center bg-light" style="height: 200px;">
                      <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-muted">
                          <i class="fas fa-map fa-2x mb-2"></i>
                          <p class="mb-0">Enter coordinates to see location preview</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Important Dates -->
        <div class="form-step" id="step-3">
          <div class="card shadow">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-calendar-alt me-2"></i>
                Important Dates
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <!-- First Contact Date -->
                  <div class="mb-3">
                    <label for="{{ form.first_contact_date.id_for_label }}" class="form-label">
                      First Contact Date
                    </label>
                    {{ form.first_contact_date|add_class:"form-control datepicker" }}
                    {% if form.first_contact_date.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.first_contact_date.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Site Survey Date -->
                  <div class="mb-3">
                    <label for="{{ form.site_survey_date.id_for_label }}" class="form-label">
                      Site Survey Date
                    </label>
                    {{ form.site_survey_date|add_class:"form-control datepicker" }}
                    {% if form.site_survey_date.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.site_survey_date.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Contract Signed Date -->
                  <div class="mb-3">
                    <label for="{{ form.contract_signed_date.id_for_label }}" class="form-label">
                      Contract Signed Date
                    </label>
                    {{ form.contract_signed_date|add_class:"form-control datepicker" }}
                    {% if form.contract_signed_date.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.contract_signed_date.errors|first }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- Project Start Date -->
                  <div class="mb-3">
                    <label for="{{ form.project_start_date.id_for_label }}" class="form-label">
                      Project Start Date
                    </label>
                    {{ form.project_start_date|add_class:"form-control datepicker" }}
                    {% if form.project_start_date.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.project_start_date.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Estimated Completion -->
                  <div class="mb-3">
                    <label for="{{ form.estimated_completion.id_for_label }}" class="form-label">
                      Estimated Completion
                    </label>
                    {{ form.estimated_completion|add_class:"form-control datepicker" }}
                    {% if form.estimated_completion.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.estimated_completion.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Date Timeline Visual -->
                  <div class="mt-4">
                    <label class="form-label">Timeline Overview</label>
                    <div id="dateTimeline" class="border rounded p-3 bg-light">
                      <div class="text-muted text-center">
                        <i class="fas fa-calendar fa-2x mb-2"></i>
                        <p class="mb-0">Date timeline will appear here as you fill in dates</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Facility Details -->
        <div class="form-step" id="step-4">
          <div class="card shadow">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-cogs me-2"></i>
                Facility Details & Requirements
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-lg-6">
                  <!-- Facility Size -->
                  <div class="mb-3">
                    <label class="form-label">Facility Size</label>
                    <div class="input-group">
                      {{ form.facility_size|add_class:"form-control" }}
                      {{ form.facility_size_unit|add_class:"form-select" }}
                    </div>
                    {% if form.facility_size.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.facility_size.errors|first }}
                      </div>
                    {% endif %}
                    {% if form.facility_size_unit.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.facility_size_unit.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Capacity -->
                  <div class="mb-3">
                    <label for="{{ form.capacity.id_for_label }}" class="form-label">
                      People Capacity
                    </label>
                    {{ form.capacity|add_class:"form-control" }}
                    {% if form.capacity.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.capacity.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Maximum number of people the facility can accommodate
                    </div>
                  </div>

                  <!-- Access Requirements -->
                  <div class="mb-3">
                    <label for="{{ form.access_requirements.id_for_label }}" class="form-label">
                      Access Requirements
                    </label>
                    {{ form.access_requirements|add_class:"form-select" }}
                    {% if form.access_requirements.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.access_requirements.errors|first }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Work Hours -->
                  <div class="mb-3">
                    <label for="{{ form.work_hours.id_for_label }}" class="form-label">
                      Work Hours
                    </label>
                    {{ form.work_hours|add_class:"form-select" }}
                    {% if form.work_hours.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.work_hours.errors|first }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-lg-6">
                  <!-- Facility Features -->
                  <div class="mb-3">
                    <label class="form-label">Facility Features</label>
                    <div class="form-check mb-2">
                      {{ form.parking_available|add_class:"form-check-input" }}
                      <label class="form-check-label" for="{{ form.parking_available.id_for_label }}">
                        <i class="fas fa-parking me-2"></i>Parking Available
                      </label>
                    </div>
                    <div class="form-check mb-2">
                      {{ form.loading_access|add_class:"form-check-input" }}
                      <label class="form-check-label" for="{{ form.loading_access.id_for_label }}">
                        <i class="fas fa-truck me-2"></i>Loading/Equipment Access
                      </label>
                    </div>
                    <div class="form-check mb-2">
                      {{ form.storage_available|add_class:"form-check-input" }}
                      <label class="form-check-label" for="{{ form.storage_available.id_for_label }}">
                        <i class="fas fa-warehouse me-2"></i>On-site Storage Available
                      </label>
                    </div>
                  </div>

                  <!-- Special Requirements -->
                  <div class="mb-3">
                    <label for="{{ form.special_requirements.id_for_label }}" class="form-label">
                      Special Requirements
                    </label>
                    {{ form.special_requirements|add_class:"form-control" }}
                    {% if form.special_requirements.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.special_requirements.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Special safety, access, or work requirements
                    </div>
                  </div>

                  <!-- Emergency Contact Info -->
                  <div class="mb-3">
                    <label for="{{ form.emergency_contact_info.id_for_label }}" class="form-label">
                      Emergency Contact Information
                    </label>
                    {{ form.emergency_contact_info|add_class:"form-control" }}
                    {% if form.emergency_contact_info.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.emergency_contact_info.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      JSON format: {"name": "John Doe", "phone": "555-123-4567", "role": "Site Manager"}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Existing Systems -->
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="{{ form.existing_systems.id_for_label }}" class="form-label">
                      Existing Systems/Equipment
                    </label>
                    {{ form.existing_systems|add_class:"form-control" }}
                    {% if form.existing_systems.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.existing_systems.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      List existing systems, equipment, or infrastructure (one per line or JSON format)
                    </div>
                  </div>

                  <!-- Custom Fields -->
                  <div class="mb-3">
                    <label for="{{ form.custom_fields.id_for_label }}" class="form-label">
                      Custom Fields
                    </label>
                    {{ form.custom_fields|add_class:"form-control" }}
                    {% if form.custom_fields.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.custom_fields.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Additional custom data in JSON format for business-specific needs
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Review & Submit -->
        <div class="form-step" id="step-5">
          <div class="card shadow">
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0">
                <i class="fas fa-check-circle me-2"></i>
                Review & Submit
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-12">
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Please review all information before submitting. You can always edit these details later.
                  </div>

                  <!-- Summary Cards -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">
                            <i class="fas fa-info-circle text-primary me-2"></i>Basic Information
                          </h6>
                          <div id="reviewBasicInfo">
                            <!-- Populated by JavaScript -->
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">
                            <i class="fas fa-map-marker-alt text-info me-2"></i>Location Details
                          </h6>
                          <div id="reviewLocationInfo">
                            <!-- Populated by JavaScript -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">
                            <i class="fas fa-calendar-alt text-warning me-2"></i>Important Dates
                          </h6>
                          <div id="reviewDateInfo">
                            <!-- Populated by JavaScript -->
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">
                            <i class="fas fa-cogs text-success me-2"></i>Facility Details
                          </h6>
                          <div id="reviewFacilityInfo">
                            <!-- Populated by JavaScript -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Form Validation Summary -->
                  <div class="mt-4">
                    <div id="validationSummary" class="d-none">
                      <!-- Populated by JavaScript if there are validation errors -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Navigation -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center">
              <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                <i class="fas fa-chevron-left me-1"></i>Previous
              </button>
              
              <div class="flex-grow-1 text-center">
                <span class="text-muted">Step <span id="currentStep">1</span> of 5</span>
              </div>
              
              <div>
                <button type="button" class="btn btn-primary me-2" id="nextBtn">
                  Next <i class="fas fa-chevron-right ms-1"></i>
                </button>
                <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                  <i class="fas fa-save me-1"></i>
                  {% if form.instance.pk %}Update Location{% else %}Create Location{% endif %}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Coordinate Picker Modal -->
<div class="modal fade" id="coordinatePickerModal" tabindex="-1" aria-labelledby="coordinatePickerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="coordinatePickerModalLabel">
          <i class="fas fa-map me-2"></i>Pick Location on Map
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" class="form-control" id="mapSearchInput" placeholder="Search for an address...">
        </div>
        <div id="mapContainer" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;">
          <div class="d-flex align-items-center justify-content-center h-100 bg-light">
            <div class="text-center text-muted">
              <i class="fas fa-map fa-3x mb-3"></i>
              <p>Map will load here</p>
              <small>Click on the map to set coordinates</small>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <div class="row">
            <div class="col-6">
              <label class="form-label">Latitude</label>
              <input type="text" class="form-control" id="modalLatitude" readonly>
            </div>
            <div class="col-6">
              <label class="form-label">Longitude</label>
              <input type="text" class="form-control" id="modalLongitude" readonly>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="useCoordinatesBtn">Use These Coordinates</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize components
    initializeSelect2();
    initializeDatepickers();
    initializeFormSteps();
    initializeImagePreview();
    initializeCoordinateHandling();
    initializeDynamicFields();
    initializeFormValidation();

    // Initialize Select2
    function initializeSelect2() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select option...',
            allowClear: true
        });
    }

    // Initialize date pickers
    function initializeDatepickers() {
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom auto'
        });
    }

    // Form step navigation
    let currentStep = 1;
    const totalSteps = 5;

    function initializeFormSteps() {
        updateStepIndicators();
        
        document.getElementById('nextBtn').addEventListener('click', nextStep);
        document.getElementById('prevBtn').addEventListener('click', prevStep);
    }

    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }

    function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(el => {
            el.classList.remove('active');
        });
        
        // Show current step
        document.getElementById(`step-${step}`).classList.add('active');
        
        currentStep = step;
        updateStepIndicators();
        updateNavigationButtons();
        
        if (step === 5) {
            populateReviewStep();
        }
    }

    function updateStepIndicators() {
        const progress = (currentStep / totalSteps) * 100;
        document.querySelector('.progress-bar').style.width = `${progress}%`;
        document.getElementById('currentStep').textContent = currentStep;
        
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            const stepNumber = index + 1;
            indicator.classList.toggle('active', stepNumber === currentStep);
            indicator.classList.toggle('completed', stepNumber < currentStep);
        });
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = currentStep < totalSteps ? 'inline-block' : 'none';
        submitBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
    }

    function validateCurrentStep() {
        const currentStepEl = document.getElementById(`step-${currentStep}`);
        const requiredFields = currentStepEl.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        return isValid;
    }

    // Image preview
    function initializeImagePreview() {
        const imageInput = document.getElementById('{{ form.profile_image.id_for_label }}');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        const previewImg = document.getElementById('previewImg');
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    // Coordinate handling
    function initializeCoordinateHandling() {
        // Get current location
        document.getElementById('getLocationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    document.getElementById('{{ form.latitude.id_for_label }}').value = position.coords.latitude.toFixed(6);
                    document.getElementById('{{ form.longitude.id_for_label }}').value = position.coords.longitude.toFixed(6);
                    updateCoordinatePreview();
                }, function(error) {
                    alert('Unable to get location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });

        // Coordinate preview update
        const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
        const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');
        
        if (latInput && lngInput) {
            latInput.addEventListener('input', updateCoordinatePreview);
            lngInput.addEventListener('input', updateCoordinatePreview);
        }

        // Use coordinates from modal
        document.getElementById('useCoordinatesBtn').addEventListener('click', function() {
            const modalLat = document.getElementById('modalLatitude').value;
            const modalLng = document.getElementById('modalLongitude').value;
            
            if (modalLat && modalLng) {
                document.getElementById('{{ form.latitude.id_for_label }}').value = modalLat;
                document.getElementById('{{ form.longitude.id_for_label }}').value = modalLng;
                updateCoordinatePreview();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('coordinatePickerModal'));
                modal.hide();
            }
        });
    }

    function updateCoordinatePreview() {
        const lat = document.getElementById('{{ form.latitude.id_for_label }}').value;
        const lng = document.getElementById('{{ form.longitude.id_for_label }}').value;
        const preview = document.getElementById('coordinatePreview');
        
        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
            preview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-map-marker-alt fa-2x text-success mb-2"></i>
                    <p class="mb-1"><strong>Location Set</strong></p>
                    <p class="mb-2">Lat: ${parseFloat(lat).toFixed(4)}, Lng: ${parseFloat(lng).toFixed(4)}</p>
                    <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>View on Maps
                    </a>
                </div>
            `;
        } else {
            preview.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-muted text-center">
                        <i class="fas fa-map fa-2x mb-2"></i>
                        <p class="mb-0">Enter coordinates to see location preview</p>
                    </div>
                </div>
            `;
        }
    }

    // Dynamic field handling
    function initializeDynamicFields() {
        const businessCategorySelect = document.getElementById('{{ form.business_category.id_for_label }}');
        const locationTypeSelect = document.getElementById('{{ form.location_type.id_for_label }}');
        const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
        const accessRequirementsSelect = document.getElementById('{{ form.access_requirements.id_for_label }}');
        const workHoursSelect = document.getElementById('{{ form.work_hours.id_for_label }}');

        if (businessCategorySelect) {
            businessCategorySelect.addEventListener('change', function() {
                const categoryId = this.value;
                updateDependentFields(categoryId);
            });

            // Initial load if category is already selected
            if (businessCategorySelect.value) {
                updateDependentFields(businessCategorySelect.value);
            }
        }

        function updateDependentFields(categoryId) {
            if (!categoryId) {
                disableField(locationTypeSelect, 'Select business category first');
                disableField(statusSelect, 'Select business category first');
                disableField(accessRequirementsSelect, 'Select business category first');
                disableField(workHoursSelect, 'Select business category first');
                return;
            }

            // Enable fields
            enableField(locationTypeSelect);
            enableField(statusSelect);
            enableField(accessRequirementsSelect);
            enableField(workHoursSelect);

            // Fetch location types
            fetch(`{% url 'location:ajax-location-types' %}?business_category=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    updateSelectOptions(locationTypeSelect, data.location_types, 'Select location type...');
                })
                .catch(error => console.error('Error fetching location types:', error));

            // Fetch dynamic choices
            const choiceTypes = ['location_status', 'access_requirement', 'work_hours'];
            choiceTypes.forEach(choiceType => {
                fetch(`{% url 'location:ajax-dynamic-choices' %}?business_category=${categoryId}&choice_type=${choiceType}`)
                    .then(response => response.json())
                    .then(data => {
                        let targetSelect;
                        let placeholder;
                        
                        switch(choiceType) {
                            case 'location_status':
                                targetSelect = statusSelect;
                                placeholder = 'Select status...';
                                break;
                            case 'access_requirement':
                                targetSelect = accessRequirementsSelect;
                                placeholder = 'Select access requirements...';
                                break;
                            case 'work_hours':
                                targetSelect = workHoursSelect;
                                placeholder = 'Select work hours...';
                                break;
                        }
                        
                        if (targetSelect) {
                            updateSelectOptions(targetSelect, data.choices, placeholder);
                        }
                    })
                    .catch(error => console.error(`Error fetching ${choiceType}:`, error));
            });
        }

        function disableField(select, helpText) {
            if (select) {
                select.disabled = true;
                select.innerHTML = `<option value="">${helpText}</option>`;
            }
        }

        function enableField(select) {
            if (select) {
                select.disabled = false;
            }
        }

        function updateSelectOptions(select, options, placeholder) {
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            
            options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option[0] || option.id;
                optionEl.textContent = option[1] || option.name;
                if (optionEl.value === currentValue) {
                    optionEl.selected = true;
                }
                select.appendChild(optionEl);
            });
        }
    }

    // Form validation
    function initializeFormValidation() {
        const form = document.getElementById('locationForm');
        
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                
                // Find first invalid field and show its step
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    const stepElement = firstInvalid.closest('.form-step');
                    if (stepElement) {
                        const stepNumber = parseInt(stepElement.id.split('-')[1]);
                        showStep(stepNumber);
                    }
                }
            }
            
            form.classList.add('was-validated');
        });

        // Real-time validation
        form.addEventListener('input', function(e) {
            if (e.target.hasAttribute('required')) {
                if (e.target.value.trim()) {
                    e.target.classList.remove('is-invalid');
                    e.target.classList.add('is-valid');
                } else {
                    e.target.classList.remove('is-valid');
                    e.target.classList.add('is-invalid');
                }
            }
        });
    }

    // Populate review step
    function populateReviewStep() {
        const basicInfo = document.getElementById('reviewBasicInfo');
        const locationInfo = document.getElementById('reviewLocationInfo');
        const dateInfo = document.getElementById('reviewDateInfo');
        const facilityInfo = document.getElementById('reviewFacilityInfo');

        // Basic Information
        const name = document.getElementById('{{ form.name.id_for_label }}').value;
        const client = document.getElementById('{{ form.client.id_for_label }}').selectedOptions[0]?.text || '';
        const businessCategory = document.getElementById('{{ form.business_category.id_for_label }}').selectedOptions[0]?.text || '';
        const status = document.getElementById('{{ form.status.id_for_label }}').selectedOptions[0]?.text || '';

        basicInfo.innerHTML = `
            <p><strong>Name:</strong> ${name || 'Not specified'}</p>
            <p><strong>Client:</strong> ${client || 'Not selected'}</p>
            <p><strong>Business Category:</strong> ${businessCategory || 'Not selected'}</p>
            <p><strong>Status:</strong> ${status || 'Not selected'}</p>
        `;

        // Location Information
        const lat = document.getElementById('{{ form.latitude.id_for_label }}').value;
        const lng = document.getElementById('{{ form.longitude.id_for_label }}').value;
        const category = document.getElementById('{{ form.location_category.id_for_label }}').value;

        locationInfo.innerHTML = `
            <p><strong>Category:</strong> ${category || 'Not specified'}</p>
            <p><strong>GPS Coordinates:</strong> ${lat && lng ? `${lat}, ${lng}` : 'Not specified'}</p>
            ${lat && lng ? `<p><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-map me-1"></i>View on Map</a></p>` : ''}
        `;

        // Date Information
        const firstContact = document.getElementById('{{ form.first_contact_date.id_for_label }}').value;
        const contractSigned = document.getElementById('{{ form.contract_signed_date.id_for_label }}').value;
        const projectStart = document.getElementById('{{ form.project_start_date.id_for_label }}').value;

        dateInfo.innerHTML = `
            <p><strong>First Contact:</strong> ${firstContact || 'Not specified'}</p>
            <p><strong>Contract Signed:</strong> ${contractSigned || 'Not specified'}</p>
            <p><strong>Project Start:</strong> ${projectStart || 'Not specified'}</p>
        `;

        // Facility Information
        const facilitySize = document.getElementById('{{ form.facility_size.id_for_label }}').value;
        const facilitySizeUnit = document.getElementById('{{ form.facility_size_unit.id_for_label }}').selectedOptions[0]?.text || '';
        const capacity = document.getElementById('{{ form.capacity.id_for_label }}').value;
        const parking = document.getElementById('{{ form.parking_available.id_for_label }}').checked;
        const loading = document.getElementById('{{ form.loading_access.id_for_label }}').checked;
        const storage = document.getElementById('{{ form.storage_available.id_for_label }}').checked;

        facilityInfo.innerHTML = `
            <p><strong>Size:</strong> ${facilitySize && facilitySizeUnit ? `${facilitySize} ${facilitySizeUnit}` : 'Not specified'}</p>
            <p><strong>Capacity:</strong> ${capacity ? `${capacity} people` : 'Not specified'}</p>
            <p><strong>Features:</strong></p>
            <ul class="list-unstyled">
                <li><i class="fas fa-${parking ? 'check text-success' : 'times text-danger'} me-2"></i>Parking</li>
                <li><i class="fas fa-${loading ? 'check text-success' : 'times text-danger'} me-2"></i>Loading Access</li>
                <li><i class="fas fa-${storage ? 'check text-success' : 'times text-danger'} me-2"></i>Storage</li>
            </ul>
        `;
    }

    // Date timeline visual
    function updateDateTimeline() {
        // This would create a visual timeline of the dates
        // Implementation depends on specific requirements
    }

    // Copy client address functionality
    const copyAddressCheckbox = document.getElementById('{{ form.copy_address_from_client.id_for_label }}');
    if (copyAddressCheckbox) {
        copyAddressCheckbox.addEventListener('change', function() {
            if (this.checked) {
                const clientId = document.getElementById('{{ form.client.id_for_label }}').value;
                if (clientId) {
                    // Fetch client address and populate location fields
                    // This would require an AJAX endpoint to get client address
                    console.log('Copy address from client:', clientId);
                }
            }
        });
    }

    // Initialize on load
    updateCoordinatePreview();
    updateNavigationButtons();
});
</script>

<style>
/* Custom CSS for location form */
.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.step-indicator {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    color: #6c757d;
    text-decoration: none;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
    font-size: 0.875rem;
}

.step-indicator.active {
    background-color: #007bff;
    color: white;
}

.step-indicator.completed {
    background-color: #28a745;
    color: white;
}

.step-indicator i {
    display: block;
    margin-bottom: 0.25rem;
}

.required::after {
    content: " *";
    color: #dc3545;
}

.image-upload-container {
    border: 2px dashed #ddd;
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
    transition: border-color 0.3s ease;
}

.image-upload-container:hover {
    border-color: #007bff;
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4M5.8 8.4l.4-.4.4.4M3.6 5.8l.4.4-.4.4M8.4 5.8l-.4.4.4.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.4-.4 1.4-1.4.4-.4-.8-.8-.4.4-.7.7-1.1-1.1-.4-.4-.8.8.4.4 1.5 1.5z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.progress-wrapper {
    margin-bottom: 0;
}

@media (max-width: 768px) {
    .step-indicator {
        font-size: 0.75rem;
        padding: 0.25rem;
    }
    
    .step-indicator span {
        display: none;
    }
}
</style>
{% endblock %}{% extends "home/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
{% if form.instance.pk %}Edit {{ form.instance.name }}{% else %}Add New Location{% endif %}
{% endblock %}

{% block extra_css %}
<link href="{% static 'location/css/form.css' %}" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'location:dashboard' %}">Locations</a></li>
    <li class="breadcrumb-item"><a href="{% url 'location:location-list' %}">All Locations</a></li>
    {% if form.instance.pk %}
    <li class="breadcrumb-item"><a href="{{ form.instance.get_absolute_url }}">{{ form.instance.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Edit</li>
    {% else %}
    <li class="breadcrumb-item active" aria-current="page">Add Location</li>
    {% endif %}
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Form Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-2">
            <i class="fas fa-map-marker-alt text-primary me-2"></i>
            {% if form.instance.pk %}
              Edit Location: {{ form.instance.name }}
            {% else %}
              Add New Location
            {% endif %}
          </h1>
          <p class="text-muted mb-0">
            {% if form.instance.pk %}
              Update location information and settings
            {% else %}
              Create a new location for project management
            {% endif %}
          </p>
        </div>
        <div>
          {% if form.instance.pk %}
          <a href="{{ form.instance.get_absolute_url }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-times me-1"></i>Cancel
          </a>
          {% else %}
          <a href="{% url 'location:location-list' %}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-times me-1"></i>Cancel
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="post" enctype="multipart/form-data" id="locationForm" novalidate>
    {% csrf_token %}
    
    <!-- Progress Indicator -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body py-2">
            <div class="progress-wrapper">
              <div class="d-flex justify-content-between">
                <span class="step-indicator active" data-step="1">
                  <i class="fas fa-info-circle"></i> Basic Info
                </span>
                <span class="step-indicator" data-step="2">
                  <i class="fas fa-map-marker-alt"></i> Location
                </span>
                <span class="step-indicator" data-step="3">
                  <i class="fas fa-calendar-alt"></i> Dates
                </span>
                <span class="step-indicator" data-step="4">
                  <i class="fas fa-cogs"></i> Details
                </span>
                <span class="step-indicator" data-step="5">
                  <i class="fas fa-check-circle"></i> Review
                </span>
              </div>
              <div class="progress mt-2">
                <div class="progress-bar" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Steps -->
    <div class="row">
      <div class="col-12">
        <!-- Step 1: Basic Information -->
        <div class="form-step active" id="step-1">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Basic Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-lg-8">
                  <!-- Location Name -->
                  <div class="mb-3">
                    <label for="{{ form.name.id_for_label }}" class="form-label required">
                      Location Name
                    </label>
                    {{ form.name|add_class:"form-control" }}
                    {% if form.name.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.name.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Choose a descriptive name that clearly identifies this location
                    </div>
                  </div>

                  <!-- Client Selection -->
                  <div class="mb-3">
                    <label for="{{ form.client.id_for_label }}" class="form-label required">
                      Client
                    </label>
                    {{ form.client|add_class:"form-select select2" }}
                    {% if form.client.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.client.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      Select the client who owns this location
                      <a href="{% url 'client:client-create' %}" target="_blank" class="ms-2">
                        <i class="fas fa-plus"></i> Add New Client
                      </a>
                    </div>
                  </div>

                  <!-- Business Category -->
                  <div class="mb-3">
                    <label for="{{ form.business_category.id_for_label }}" class="form-label required">
                      Business Category
                    </label>
                    {{ form.business_category|add_class:"form-select select2" }}
                    {% if form.business_category.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.business_category.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      This determines available options and terminology throughout the system
                    </div>
                  </div>

                  <!-- Location Type (Dynamic) -->
                  <div class="mb-3">
                    <label for="{{ form.location_type.id_for_label }}" class="form-label">
                      Location Type
                    </label>
                    {{ form.location_type|add_class:"form-select" }}
                    {% if form.location_type.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.location_type.errors|first }}
                      </div>
                    {% endif %}
                    <div class="form-text">
                      <span id="locationTypeHelp">Select a business category first</span>
                    </div>
                  </div>

                  <!-- Status (Dynamic) -->
                  <div class="mb-3">
                    <label for="{{ form.status.id_for_label }}" class="form-label">
                      Status
                    </label>
                    {{ form.status|add_class:"form-select" }}
                    {% if form.status.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.status.errors|first }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-lg-4">
                  <!-- Profile Image -->
                  <div class="mb-3">
                    <label for="{{ form.profile_image.id_for_label }}" class="form-label">
                      Profile Image
                    </label>
                    <div class="image-upload-container">
                      {% if form.instance.profile_image %}
                      <div class="current-image mb-2">
                        <img src="{{ form.instance.profile_image.url }}" 
                             alt="Current image" 
                             class="img-fluid rounded"
                             style="max-height: 200px;">
                      </div>
                      {% endif %}
                      {{ form.profile_image|add_class:"form-control" }}
                      <div class="image-preview mt-2" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded" style="max-height
